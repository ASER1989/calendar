<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="yes" name="apple-touch-fullscreen">
    <meta name="viewport"
          content="width=device-width, initial-scale=1,maximum-scale=1,maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>今日事项</title>
    <link rel="stylesheet" href="css/tips.css?v=1">

</head>
<body>
<header>
    <h2>2017年12月12日</h2>
    <div>星期二 十月廿五</div>
</header>
<section class="tip-content">
    <ul class="tip-list">
        <div class="align-center">加载中...</div>
    </ul>
</section>
<footer data-click="showDialog">
    添加提醒
</footer>
<section class="dialog hide">
    <section class="dia-content">
        <textarea class="input-dia-ctx" placeholder="请输入提醒内容！"></textarea>
        <div class="dia-opt">
            <a href="javascript:void(0)" data-click="cancel">取消</a>
            <a href="javascript:void(0)" data-click="submit">保存</a>
        </div>
    </section>
</section>
<script type="text/html" id="_list_temp">
    <%for(var i=0,item;item=data[i++];){%>
    <li><%=item.ctn%><a href="javascript:void(0);" data-id="<%=item.id%>" data-click="itemDel"></a></li>
    <%}%>
    <%if(data==null || data.length==0){%>
    <div class="align-center">暂无记录</div>
    <%}%>
</script>
<script src="js/lib/me.require.js"></script>
<script type="text/javascript">
    require(['./js/lib/zepto.js',
            './js/lib/zoom.js',
            './js/site.config.js',
            './js/lib/underscore.js'],
        function () {
            var pagezoom = new zoom($);
            pagezoom.calc(function () {
                var els = {
                    dialog: $(".dialog"),
                    diaTxt: $(".dialog .input-dia-ctx"),
                    listUl: $('.tip-list')
                }
                var temp = {
                    list: _.template($("#_list_temp").html())
                }
                var event = {
                    init: function () {
                        var clicks = $("[data-click]");
                        bind(clicks, "click");
                        function bind(els, type) {
                            for (var i = 0, el; el = els[i++];) {
                                el = $(el);
                                el.off().on(type, event[el.attr("data-" + type)]);
                            }
                        }
                    },
                    cancel: function () {
                        els.dialog.addClass('hide');
                        els.diaTxt.val('');
                    },
                    submit: function () {
                        ctrl.save(function () {
                            els.dialog.addClass('hide');
                            els.diaTxt.val('');
                        });

                    },
                    showDialog: function () {
                        els.dialog.removeClass('hide');
                    },
                    itemDel: function () {
                        var id = $(this).attr("data-id");
                        ctrl.delItem(id);
                    }
                }
                var ctrl = {
                    date: GetQueryStr('y'),
                    week: GetQueryStr('week'),
                    yue: GetQueryStr('yue'),
                    ready: function () {
                        $('header h2').html(ctrl.date.replace('-', '年').replace('-', '月') + '日');
                        $('header div').html(ctrl.week + ' ' + ctrl.yue);
                    },
                    save: function (fn) {
                        var txt = els.diaTxt.val();
                        if (txt == null || txt.length < 1) {
                            alert("请输入提醒内容");
                            return;
                        }
                        $.ajax({
                            url: "/charge/adduserrecord",
                            data: {
                                recorddate: ctrl.date,
                                ctn: els.diaTxt.val()
                            },
                            success: function (data) {
                                if (data.status == 0) {
                                    ctrl.getList();
                                    alert("添加成功");
                                }
                                typeof fn == "function" && fn.call();
                            }
                        })
                    },
                    getList: function () {
                        $.ajax({
                            url: "/charge/userrecordlist",
                            data: {
                                seldate: ctrl.date
                            },
                            type: "POST",
                            success: function (data) {
                                els.listUl.html(temp.list(data));
                                event.init();
                            }
                        });
                    },
                    delItem: function (id) {
                        $.ajax({
                            url: "/charge/deluserrecord",
                            data: {
                                id: id
                            },
                            type: "POST",
                            success: function (data) {
                                if (data.status == 0) {
                                    ctrl.getList();
                                    alert("操作成功");
                                }
                            }
                        });
                    }
                }
                ctrl.ready();
                event.init();
                ctrl.getList();


            });
            $(window).on('resize', pagezoom.calc);
        });
</script>
</body>
</html>
